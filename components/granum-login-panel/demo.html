<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!doctype html>
<html>
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <title>granum-login-panel</title>

  <script src="../webcomponentsjs/webcomponents.js"></script>
  <script src="./AuthServiceAdaptor.js"></script>

  <link href="../font-roboto/roboto.html" rel="import">
  <link href="../core-pages/core-pages.html" rel="import">
  <link href="../paper-button/paper-button.html" rel="import">
  <link href="../paper-dialog/paper-action-dialog.html" rel="import">
  <link href="../paper-dialog/paper-dialog.html" rel="import">
  <link href="../paper-shadow/paper-shadow.html" rel="import">


  <link rel="import" href="../core-overlay/core-overlay.html">
  <link rel="import" href="../core-header-panel/core-header-panel.html">
  <link rel="import" href="../core-transition/core-transition.html">
  <link rel="import" href="../core-media-query/core-media-query.html">
  <link rel="import" href="../core-toolbar/core-toolbar.html">
  <link href="granum-login-panel.html" rel="import">

  <style shim-shadowdom>
    body {
      font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial, serif;
      font-size: 14px;
      margin: 0;
      padding: 24px;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      -webkit-touch-callout: none;
    }

    button {
      margin: 8px 4px;
    }

    html /deep/ #idLoginPanel::shadow .content {
      background-color: #fdfdfd;
    }

    html /deep/ #idLoginDialog::shadow #scroller {
      padding: 0;
    }

    .header-button {
      background-color: #ccc;
      font-size: 12pt;

    }

    .core-header {
      margin-bottom: 2em;
    }

  </style>
</head>
<body unresolved fullbleed vertical layout>

<template is="auto-binding">

  <core-header-panel fit mode="scroll">
    <div class="core-header">
      <core-toolbar style="background: #4285f4;">
        <paper-button raised
                      class="header-button"
                      disabled?="{{selectedPage == 0}}"
                      on-tap="{{nextPage}}">Home
        </paper-button>
        <paper-button raised
                      disabled?="{{selectedPage == 1}}"
                      class="header-button"
                      on-tap="{{nextPage}}">Login Page
        </paper-button>
        <paper-button raised
                      class="header-button"
                      on-tap="{{toggleLogin}}">Toggle Dialog
        </paper-button>
        <span flex></span>

        <span>Login Panel Demo</span>
      </core-toolbar>
    </div>
    <div class="content" fit>
      <paper-action-dialog id="idLoginDialog">
        <granum-login-panel
            username="bob@example.com"
            authServiceAdaptor="{{authServiceAdaptor}}"
            requireEmailUsername="true"
            on-login-success="{{onLoginSuccess}}"
            on-signup-success="{{onSignupSuccess}}"></granum-login-panel>
      </paper-action-dialog>

      <core-pages id="idPages" fit selected="{{selectedPage}}" layout vertical center-center>
        <section layout horizontal around-justified>
          <h2>Choose one of the views from above.</h2>
        </section>

        <section layout vertical center-center>
          <div flex layout vertical start>
            <div>
              <h2>As a 'flat' element, lying within the panel.</h2>
            </div>
            <granum-login-panel id="idLoginPanel"
                                username="bob@example.com"
                                authServiceAdaptor="{{authServiceAdaptor}}"
                                shadowed="{{!phoneScreen}}"
                                requireEmailUsername="true"
                                on-login-success="{{onLoginSuccess}}"
                                on-signup-success="{{onSignupSuccess}}"></granum-login-panel>
          </div>
        </section>
      </core-pages>

    </div>
  </core-header-panel>
  <core-media-query query="max-width: 640px" queryMatches="{{phoneScreen}}"></core-media-query>
</template>

<script>
  var scope = document.querySelector('template[is=auto-binding]');
  // No point creating, you should only ever have one copy. Still, global objects === yuck. Pass an instance variable around so you can mock something up
  // when you finally write unit tests ;~)
  var authAdaptor = window.AuthServiceAdaptor;

  var performLogin = function () {
    console.log("Logging in...", arguments);
    authAdaptor.handleLoginSuccess("No-op Login action");
  };

  var performSignup = function () {
    console.log("Logging in...", arguments);
    authAdaptor.handleSignupSuccess("No-op signup action");
  };
  authAdaptor.setAuthActions(performLogin, performSignup);

  var foo = {
    selectedPage: 0,

    // call back actions are set by the login panel, to which this field is bound (see above)
    authServiceAdaptor: AuthServiceAdaptor,
    nextPage: function (e, idx, sender) {
      console.log("current page: ", this.selectedPage, this.$.idPages.items);
      this.selectedPage = (this.selectedPage + 1) % this.$.idPages.items.length;
    },

    /* Listens to the _login panel_, so that a quick welcome message can be displayed. */
    onLoginSuccess: function () {
      console.log("Login action complete, ready to hide dialog / page away.");
      if (this.selectedPage == 1) {
        this.selectedPage = 0;
      }
      else if (this.$.idLoginDialog && this.$.idLoginDialog.opened) {
        this.$.idLoginDialog.toggle();
      }
    },
    /* Ditto */
    onSignupSuccess: function () {
      console.log("Signup action complete, ready to hide dialog / page away.");
      if(this.selectedPage == 1){
        this.selectedPage = 0;
      }
      else if (this.$.idLoginDialog && this.$.idLoginDialog.opened) {
        this.$.idLoginDialog.toggle();
      }
    },

    toggleLogin: function (e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      this.$.idLoginDialog.toggle();
      return false;
    },

    ready: function () {
      /* Uncomment for quick editing of Dialog view with BrowserSync*/
      /*this.async(this.toggleLogin);*/

      /* Uncomment this line for quick editing of the page view: */
//      this.selectedPage = 1;

    }
  };

  /* probably requires polyfills.js, or your own version of same. */
  Object.assign(scope, foo);

</script>

</body>
</html>
